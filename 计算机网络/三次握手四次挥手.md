# 三次握手四次挥手

在TCP中，连接和断开就是必考的选项。

## 三个握手

![image-20220517172155684](/Users/lizhongzheng/Library/Application Support/typora-user-images/image-20220517172155684.png)

### 第一次握手

第一次握手是客户端发送的请求，向服务端发出的，这个时候，客户端会随机一个序列号，然后将SYN置为1，然后服务端接收到数据。

### 第二次握手

服务端接收到客户端的请求，将ACK置为1，然后随机一个序列号，将客户端的序列号+1，然后将数据进行返回。

### 第三次握手

客户端接收到数据后，将服务端的序列号+1，然后将ACK置为1，然后返回数据

### 为什么是三次握手

三次握手的必要性：

1. 确保不是旧连接
2. 对序列号进行初始化
3. 避免资源的浪费

#### 确保不是旧连接

在TCP第二次握手的时候，可以通过上下文进行判别，如果是旧连接就直接终止

#### 对序列号的初始化

在进行序列号的传输的时候，客户端是需要对服务端的序列号进行存储的同理服务端要存储客户端的序列号

#### 避免资源的浪费

如果说没有第三次握手的情况，这个时候，没有办法确认收到的数据包，所以每收到客户端的SYN包就建立一个连接，这个时候肯定是对资源的浪费。

## 四次挥手

![image-20220517192551549](/Users/lizhongzheng/Library/Application Support/typora-user-images/image-20220517192551549.png)

### 第一次挥手

第一次挥手的时候是客户端进行的请求，第一次挥手开始，客户端就没有请求了，这个时候，将FIN置为1，然后等待服务端的响应

### 第二次挥手

第二次挥手的时候，服务端进行了断开连接的回应，返回了一个ack包，然后这个时候，服务端会将之前客户端的请求处理结束然后进行第三次挥手

### 第三次挥手

第三次挥手，这个时候已经将响应的数据发送结束，然后将fin置为1，然后传输给客户端，然后客户端接收到请求进行第四次挥手

### 第四次挥手

这个时候是对最后服务端请求的确认，这个时候返回ack包，当服务端一接收到ack后直接断开连接，然后客户端有一个time_wait时间，这个时间是2msl。然后进入close状态。

### 为什么是四次握手

在这里时候，fin包表示的是不在发出请求但是是可以接受数据的，所以我们的fin和ack包会分开发送，所以是四次挥手

### 为什么是等待2MSL时间

因为在传输的时候，可能有发送发的数据包，然后在进行发送包的时候，进行处理然后返回，这个时间就是两倍的。

### 为什么需要wait_time

如果没有这个时间，如果有旧的连接，对这个TCP连接进行复用会对数据造成混乱，如果等到2MSL时间是足够让数据包消失的，等到的时候有syn进行创建连接这个时候会被终止。